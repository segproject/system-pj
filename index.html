<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>üìÖ SYSTEM - PJ RP</title>
    <style>
        /* ... (todo el CSS original se mantiene igual) ... */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: #f9f9fa;
            color: #333;
            line-height: 1.6;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .tabs button {
            padding: 12px 24px;
            font-size: 18px;
            font-weight: bold;
            background-color: #ecf0f1;
            color: #2c3e50;
            border: none;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tabs button.active {
            background-color: #3498db;
            color: white;
        }
        .tab-content {
            display: none;
            width: 100%;
            max-width: 800px;
        }
        .tab-content.active {
            display: block;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .form-group {
            margin-bottom: 18px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 15px;
        }
        select, input, button {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            padding: 12px;
            border-radius: 8px;
            transition: background-color 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        button:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
        }
        .btn-limpiar {
            background-color: #e74c3c;
        }
        .btn-limpiar:hover {
            background-color: #c0392b;
        }
        .btn-eliminar {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-eliminar:hover {
            background-color: #c0392b;
            transform: scale(1.05);
        }
        .tienda-form {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 15px;
        }
        .tienda-form > * {
            flex: 1;
            min-width: 150px;
        }
        .tienda-btns {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        .tienda-btns button {
            flex: 1;
            min-width: 120px;
        }
        .tienda-tabla-container {
            margin-top: 20px;
            overflow-x: auto;
        }
        .tienda-tabla {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .tienda-tabla th,
        .tienda-tabla td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .tienda-tabla th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }
        .sticker-container {
            width: 100%;
            max-width: 500px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border: 2px solid #007bff;
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            display: none;
            transition: all 0.3s ease;
        }
        .sticker-title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #007bff;
            letter-spacing: 0.5px;
        }
        .sticker-producto {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
            padding: 12px;
            background-color: #e9f7fe;
            border-radius: 8px;
            border: 1px solid #cce5ff;
        }
        .sticker-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }
        .sticker-table th, .sticker-table td {
            border: 1px solid #007bff;
            padding: 10px;
            text-align: center;
        }
        .sticker-table th {
            background-color: #cce5ff;
            font-weight: bold;
            font-size: 15px;
        }
        .sticker-table .label {
            font-weight: bold;
            background-color: #e9f7fe;
            width: 80px;
        }
        .sticker-table .time-col { width: 80px; }
        .resumen-fechas {
            background: #eaf2f8;
            padding: 15px;
            border-left: 4px solid #007bff;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 15px;
            line-height: 1.7;
            color: #2c3e50;
        }
        .resumen-fechas p {
            margin: 0;
            padding: 0;
        }
        .resumen-fechas strong {
            color: #007bff;
        }
        .ajuste-aviso {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
            text-align: center;
            font-weight: 500;
        }
        #authTienda {
            text-align: center;
            margin-bottom: 20px;
        }
        #authTienda input {
            padding: 10px;
            width: 80%;
            max-width: 300px;
            margin-bottom: 10px;
        }
        #mensajeErrorTienda {
            color: red;
            margin-top: 10px;
            display: none;
        }
        @media (max-width: 600px) {
            .tabs button {
                font-size: 16px;
                padding: 10px 16px;
            }
            .container { padding: 15px; margin: 10px; }
            h1 { font-size: 24px; }
            .sticker-container { padding: 15px; margin: 15px auto; }
            .sticker-title { font-size: 22px; }
            .sticker-producto { font-size: 16px; padding: 10px; }
            .sticker-table th, .sticker-table td { padding: 8px; font-size: 13px; }
            .btn-group, .tienda-form, .tienda-btns { flex-direction: column; }
            .resumen-fechas { font-size: 14px; }
        }
        .sticker-container.fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <!-- PESTA√ëAS -->
    <div class="tabs">
        <button class="active" onclick="cambiarPestana('fechador')">üìÖ Fechador</button>
        <button onclick="cambiarPestana('ingreso')">üì¶ Ingreso de QCC</button>
    </div>

    <!-- PESTA√ëA 1: FECHADOR -->
    <div id="fechador" class="tab-content active">
        <!-- ... (todo el contenido del fechador se mantiene igual) ... -->
        <div class="container">
            <h1>üìÖ Fechador - PJ RP</h1>
            <div class="form-group">
                <label for="producto">üì¶ Seleccione el Producto:</label>
                <select id="producto" onchange="updateShelfLife()">
                    <!-- opciones igual que en el original -->
                    <option value="">-- Seleccione un producto --</option>
                    <optgroup label="üçñ C√ÅRNICOS EN TROZOS Y RODAJAS">
                        <option value="Alitas de pollo - local">Alitas de pollo - local</option>
                        <option value="Poppers de pollo">Poppers de pollo</option>
                        <option value="Pollo asado - importado">Pollo asado - importado</option>
                        <option value="Salchicha italiana">Salchicha italiana</option>
                        <option value="Chorizo - local">Chorizo - local</option>
                        <option value="Chorizo Parrillero">Chorizo Parrillero</option>
                        <option value="Carne de res - local">Carne de res - local</option>
                        <option value="Salchicha de cerdo">Salchicha de cerdo</option>
                        <option value="Tocino">Tocino</option>
                        <option value="Pepperoni de cerdo">Pepperoni de cerdo</option>
                        <option value="Jam√≥n - local">Jam√≥n - local</option>
                    </optgroup>
                    <optgroup label="üßÄ QUESOS">
                        <option value="Queso Mozzarella">Queso Mozzarella</option>
                        <option value="Queso en tiras">Queso en tiras</option>
                        <option value="Mezcla de 3 quesos (Asiago, Fontina, Provolone)">Mezcla de 3 quesos (Asiago, Fontina, Provolone)</option>
                        <option value="Mezcla de 2 quesos (Romano y Parmesano)">Mezcla de 2 quesos (Romano y Parmesano)</option>
                    </optgroup>
                    <optgroup label="ü•¨ FRUTAS Y VEGETALES">
                        <option value="Champi√±√≥n">Champi√±√≥n</option>
                        <option value="Cebolla blanca/roja">Cebolla blanca/roja</option>
                        <option value="Pimiento rojo">Pimiento rojo</option>
                        <option value="Pimiento verde">Pimiento verde</option>
                        <option value="Tomate">Tomate</option>
                        <option value="Jalape√±os">Jalape√±os</option>
                        <option value="Aceituna negra">Aceituna negra</option>
                        <option value="Aceituna verde">Aceituna verde</option>
                        <option value="Pi√±a - lata">Pi√±a - lata</option>
                        <option value="Pepperoncini">Pepperoncini</option>
                    </optgroup>
                    <optgroup label="üßÇ SALSAS">
                        <option value="Salsa pizza - lata">Salsa pizza - lata</option>
                        <option value="Salsa de mayonesa con aj√≠ limo">Salsa de mayonesa con aj√≠ limo</option>
                        <option value="Salsa rosada (1kg)">Salsa rosada (1kg)</option>
                        <option value="Salsa rosada (0.5 kg)">Salsa rosada (0.5 kg)</option>
                        <option value="Salsa Parrillera">Salsa Parrillera</option>
                        <option value="Salsa de ajo (botella - granel)">Salsa de ajo (botella - granel)</option>
                        <option value="Salsa de mango habanero (bolsa)">Salsa de mango habanero (bolsa)</option>
                        <option value="Salsa Ranch">Salsa Ranch</option>
                        <option value="Salsa Bechamel">Salsa Bechamel</option>
                        <option value="Salsa Chimichurri">Salsa Chimichurri</option>
                        <option value="Salsa de ajo (blister - cup)">Salsa de ajo (blister - cup)</option>
                        <option value="Salsa Parmesana (botella - granel)">Salsa Parmesana (botella - granel)</option>
                        <option value="Salsa BBQ (blister - cup)">Salsa BBQ (blister - cup)</option>
                        <option value="Salsa BBQ (bolsa)">Salsa BBQ (bolsa)</option>
                        <option value="Salsa Buffalo (blister - cup)">Salsa Buffalo (blister - cup)</option>
                        <option value="Salsa de Miel Picante">Salsa de Miel Picante</option>
                    </optgroup>
                    <optgroup label="üßÇ OTROS INSUMOS">
                        <option value="Dustinator">Dustinator</option>
                        <option value="Masa Croisant">Masa Croisant</option>
                        <option value="Masa delgada - importada">Masa delgada - importada</option>
                        <option value="Az√∫car glaseada (Icing) - local">Az√∫car glaseada (Icing) - local</option>
                        <option value="Cinamon Spreed">Cinamon Spreed</option>
                        <option value="Or√©gano - sachet">Or√©gano - sachet</option>
                        <option value="Aji panca - sachet">Aji panca - sachet</option>
                        <option value="Or√©gano - granel">Or√©gano - granel</option>
                        <option value="Aji panca - granel">Aji panca - granel</option>
                        <option value="Sazonador italiano">Sazonador italiano</option>
                        <option value="Pasta de lasagna">Pasta de lasagna</option>
                        <option value="Tortilla">Tortilla</option>
                        <option value="Manjar Blanco">Manjar Blanco</option>
                        <option value="Az√∫car Impalpable">Az√∫car Impalpable</option>
                    </optgroup>
                    <optgroup label="üéâ PREPS">
                        <option value="Lasagna (All the meats/The Works/Americana)">Lasagna (All the meats/The Works/Americana)</option>
                        <option value="Rollitos de Pepperoni/Jam√≥n">Rollitos de Pepperoni/Jam√≥n</option>
                        <option value="Rollitos de Manjar">Rollitos de Manjar</option>
                        <option value="Rollitos de Canela">Rollitos de Canela</option>
                    </optgroup>
                </select>
            </div>
            <div class="form-group" id="recibidoSection"></div>
            <div class="form-group">
                <label for="preparadoFecha">üç≥ PREPARADO - Fecha de Inicio:</label>
                <input type="date" id="preparadoFecha" />
                <label for="preparadoHora">‚è∞ Hora de Inicio (HH:MM):</label>
                <input type="time" id="preparadoHora" />
                <div id="preparadoManualVencInput" class="manual-input" style="display:none;">
                    <label for="preparadoVencFecha">üìÜ Fecha de Vencimiento (Seg√∫n empaque):</label>
                    <input type="date" id="preparadoVencFecha" />
                    <label for="preparadoVencHora">üïí Hora de Vencimiento (HH:MM):</label>
                    <input type="time" id="preparadoVencHora" />
                </div>
            </div>
            <div class="form-group">
                <label for="lineaFecha">üè≠ L√çNEA - Fecha de Inicio:</label>
                <input type="date" id="lineaFecha" />
                <label for="lineaHora">‚è∞ Hora de Inicio (HH:MM):</label>
                <input type="time" id="lineaHora" />
                <div id="lineaManualVencInput" class="manual-input" style="display:none;">
                    <label for="lineaVencFecha">üìÜ Fecha de Vencimiento (Seg√∫n empaque):</label>
                    <input type="date" id="lineaVencFecha" />
                    <label for="lineaVencHora">üïí Hora de Vencimiento (HH:MM):</label>
                    <input type="time" id="lineaVencHora" />
                </div>
            </div>
            <div style="display:flex; gap:10px; width:100%;">
                <button onclick="calcularVencimientos()" style="flex:1;">‚úÖ Generar Sticker</button>
                <button class="btn-limpiar" onclick="limpiarFormulario()" style="flex:1;">üßπ Limpiar</button>
            </div>
        </div>
        <div class="sticker-container" id="stickerContainer">
            <div class="sticker-title">üì¶ PRODUCTO</div>
            <div class="sticker-producto" id="stickerProducto"></div>
            <table class="sticker-table">
                <thead>
                    <tr>
                        <th></th>
                        <th>FECHA</th>
                        <th>HORA</th>
                        <th>FECHA VENC.</th>
                        <th>HORA VENC.</th>
                    </tr>
                    <tr><td colspan="5" style="height:5px;background-color:#007bff;"></td></tr>
                </thead>
                <tbody id="stickerBody"></tbody>
            </table>
            <div class="ajuste-aviso" id="ajusteAviso" style="display:none;"></div>
            <div class="resumen-fechas" id="resumenFechas" style="display:none;">
                <p><strong>üìÖ Fechas de vencimiento:</strong></p>
                <p>- <strong>RECIBIDO:</strong> <span id="resumenRecibido">-</span></p>
                <p>- <strong>PREPARADO:</strong> <span id="resumenPreparado">-</span></p>
                <p>- <strong>EN L√çNEA:</strong> <span id="resumenLinea">-</span></p>
            </div>
        </div>
    </div>

    <!-- PESTA√ëA 2: INGRESO DE QCC -->
    <div id="ingreso" class="tab-content">
        <div id="authTienda" class="container">
            <h2>üîí Acceso a Ingreso de QCC</h2>
            <input type="password" id="claveTienda" placeholder="Ingrese la contrase√±a" />
            <br>
            <button onclick="validarClaveTienda()">üîì Desbloquear</button>
            <p id="mensajeErrorTienda">‚ùå Contrase√±a incorrecta</p>
        </div>
        <div id="seccionTienda" class="container" style="display:none;">
            <h1>üì¶ Ingreso de QCC</h1>
            <div class="tienda-form">
                <select id="tiendaProducto">
                    <!-- mismas opciones que en el fechador -->
                    <option value="">-- Seleccione un producto --</option>
                    <optgroup label="üçñ C√ÅRNICOS EN TROZOS Y RODAJAS">
                        <option value="Alitas de pollo - local">Alitas de pollo - local</option>
                        <option value="Poppers de pollo">Poppers de pollo</option>
                        <option value="Pollo asado - importado">Pollo asado - importado</option>
                        <option value="Salchicha italiana">Salchicha italiana</option>
                        <option value="Chorizo - local">Chorizo - local</option>
                        <option value="Chorizo Parrillero">Chorizo Parrillero</option>
                        <option value="Carne de res - local">Carne de res - local</option>
                        <option value="Salchicha de cerdo">Salchicha de cerdo</option>
                        <option value="Tocino">Tocino</option>
                        <option value="Pepperoni de cerdo">Pepperoni de cerdo</option>
                        <option value="Jam√≥n - local">Jam√≥n - local</option>
                    </optgroup>
                    <optgroup label="üßÄ QUESOS">
                        <option value="Queso Mozzarella">Queso Mozzarella</option>
                        <option value="Queso en tiras">Queso en tiras</option>
                        <option value="Mezcla de 3 quesos (Asiago, Fontina, Provolone)">Mezcla de 3 quesos (Asiago, Fontina, Provolone)</option>
                        <option value="Mezcla de 2 quesos (Romano y Parmesano)">Mezcla de 2 quesos (Romano y Parmesano)</option>
                    </optgroup>
                    <optgroup label="ü•¨ FRUTAS Y VEGETALES">
                        <option value="Champi√±√≥n">Champi√±√≥n</option>
                        <option value="Cebolla blanca/roja">Cebolla blanca/roja</option>
                        <option value="Pimiento rojo">Pimiento rojo</option>
                        <option value="Pimiento verde">Pimiento verde</option>
                        <option value="Tomate">Tomate</option>
                        <option value="Jalape√±os">Jalape√±os</option>
                        <option value="Aceituna negra">Aceituna negra</option>
                        <option value="Aceituna verde">Aceituna verde</option>
                        <option value="Pi√±a - lata">Pi√±a - lata</option>
                        <option value="Pepperoncini">Pepperoncini</option>
                    </optgroup>
                    <optgroup label="üßÇ SALSAS">
                        <option value="Salsa pizza - lata">Salsa pizza - lata</option>
                        <option value="Salsa de mayonesa con aj√≠ limo">Salsa de mayonesa con aj√≠ limo</option>
                        <option value="Salsa rosada (1kg)">Salsa rosada (1kg)</option>
                        <option value="Salsa rosada (0.5 kg)">Salsa rosada (0.5 kg)</option>
                        <option value="Salsa Parrillera">Salsa Parrillera</option>
                        <option value="Salsa de ajo (botella - granel)">Salsa de ajo (botella - granel)</option>
                        <option value="Salsa de mango habanero (bolsa)">Salsa de mango habanero (bolsa)</option>
                        <option value="Salsa Ranch">Salsa Ranch</option>
                        <option value="Salsa Bechamel">Salsa Bechamel</option>
                        <option value="Salsa Chimichurri">Salsa Chimichurri</option>
                        <option value="Salsa de ajo (blister - cup)">Salsa de ajo (blister - cup)</option>
                        <option value="Salsa Parmesana (botella - granel)">Salsa Parmesana (botella - granel)</option>
                        <option value="Salsa BBQ (blister - cup)">Salsa BBQ (blister - cup)</option>
                        <option value="Salsa BBQ (bolsa)">Salsa BBQ (bolsa)</option>
                        <option value="Salsa Buffalo (blister - cup)">Salsa Buffalo (blister - cup)</option>
                        <option value="Salsa de Miel Picante">Salsa de Miel Picante</option>
                    </optgroup>
                    <optgroup label="üßÇ OTROS INSUMOS">
                        <option value="Dustinator">Dustinator</option>
                        <option value="Masa Croisant">Masa Croisant</option>
                        <option value="Masa delgada - importada">Masa delgada - importada</option>
                        <option value="Az√∫car glaseada (Icing) - local">Az√∫car glaseada (Icing) - local</option>
                        <option value="Cinamon Spreed">Cinamon Spreed</option>
                        <option value="Or√©gano - sachet">Or√©gano - sachet</option>
                        <option value="Aji panca - sachet">Aji panca - sachet</option>
                        <option value="Or√©gano - granel">Or√©gano - granel</option>
                        <option value="Aji panca - granel">Aji panca - granel</option>
                        <option value="Sazonador italiano">Sazonador italiano</option>
                        <option value="Pasta de lasagna">Pasta de lasagna</option>
                        <option value="Tortilla">Tortilla</option>
                        <option value="Manjar Blanco">Manjar Blanco</option>
                        <option value="Az√∫car Impalpable">Az√∫car Impalpable</option>
                    </optgroup>
                    <optgroup label="üéâ PREPS">
                        <option value="Lasagna (All the meats/The Works/Americana)">Lasagna (All the meats/The Works/Americana)</option>
                        <option value="Rollitos de Pepperoni/Jam√≥n">Rollitos de Pepperoni/Jam√≥n</option>
                        <option value="Rollitos de Manjar">Rollitos de Manjar</option>
                        <option value="Rollitos de Canela">Rollitos de Canela</option>
                    </optgroup>
                </select>
                <input type="date" id="tiendaFechaRecibido" placeholder="Fecha recibido" />
            </div>
            <div class="tienda-btns">
                <button onclick="agregarALista()">‚ûï Agregar</button>
                <button class="btn-limpiar" onclick="nuevaLista()">üìÑ Nueva Lista</button>
                <button onclick="descargarExcel()">üì• Excel</button>
                <button onclick="guardarLista()">üíæ Guardar Lista</button>
                <button onclick="cargarLista()">‚úîÔ∏è Checklist</button>
                <button onclick="document.getElementById('archivoExcel').click()">üì§ Importar Lista</button>
                <input type="file" id="archivoExcel" accept=".xlsx, .xls" style="display:none;" onchange="importarExcel(event)" />
            </div>
            <div class="tienda-tabla-container">
                <table class="tienda-tabla" id="tablaIngresoTienda">
                    <thead id="tablaIngresoTiendaHead">
                        <tr>
                            <th>Producto</th>
                            <th>Fecha Recibido</th>
                            <th>Vida √∫til (d√≠as)</th>
                            <th>Fecha Vencimiento</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="cuerpoTablaTienda"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Librer√≠a SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script>
        // === Cambiar pesta√±a ===
        function cambiarPestana(seccion) {
            document.querySelectorAll('.tabs button').forEach(btn => btn.classList.remove('active'));
            if (seccion === 'fechador') {
                document.querySelectorAll('.tabs button')[0].classList.add('active');
            } else {
                document.querySelectorAll('.tabs button')[1].classList.add('active');
            }
            document.getElementById('fechador').classList.toggle('active', seccion === 'fechador');
            document.getElementById('ingreso').classList.toggle('active', seccion === 'ingreso');
        }

        // === Contrase√±a para ingreso ===
        const CLAVE_TIENDA = "pj";
        function validarClaveTienda() {
            const input = document.getElementById('claveTienda').value;
            const error = document.getElementById('mensajeErrorTienda');
            const seccion = document.getElementById('seccionTienda');
            const authBlock = document.getElementById('authTienda');
            if (input === CLAVE_TIENDA) {
                authBlock.style.display = 'none';
                seccion.style.display = 'block';
            } else {
                error.style.display = 'block';
                setTimeout(() => error.style.display = 'none', 3000);
            }
        }

        // === OBJETOS COMPARTIDOS ===
        const vidaUtil = {
            // ... (todo el objeto vidaUtil original se mantiene igual) ...
            "Alitas de pollo - local": { recibido: 7, preparado: 7, linea: 1 },
            "Poppers de pollo": { recibido: 7, preparado: 7, linea: 1 },
            "Pollo asado - importado": { recibido: 10, preparado: 7, linea: 1 },
            "Salchicha italiana": { recibido: 12, preparado: 7, linea: 1 },
            "Chorizo - local": { recibido: 7, preparado: 4, linea: 1 },
            "Chorizo Parrillero": { recibido: "Seg√∫n empaque", preparado: 6, linea: 1 },
            "Carne de res - local": { recibido: 12, preparado: 7, linea: 2 },
            "Salchicha de cerdo": { recibido: 12, preparado: 7, linea: 2 },
            "Tocino": { recibido: 30, preparado: 7, linea: 2 },
            "Pepperoni de cerdo": { recibido: 30, preparado: 7, linea: 2 },
            "Jam√≥n - local": { recibido: 14, preparado: 7, linea: 2 },
            "Queso Mozzarella": { recibido: 14, preparado: 7, linea: 1 },
            "Queso en tiras": { recibido: 14, preparado: 7, linea: 1 },
            "Mezcla de 3 quesos (Asiago, Fontina, Provolone)": { recibido: 7, preparado: 7, linea: 1 },
            "Mezcla de 2 quesos (Romano y Parmesano)": { recibido: 7, preparado: 7, linea: 1 },
            "Champi√±√≥n": { recibido: "Seg√∫n empaque", preparado: 1, linea: "11:59 p. m." },
            "Cebolla blanca/roja": { recibido: "Seg√∫n empaque", preparado: 2, linea: "11:59 p. m." },
            "Pimiento rojo": { recibido: "Seg√∫n empaque", preparado: 2, linea: "11:59 p. m." },
            "Pimiento verde": { recibido: "Seg√∫n empaque", preparado: 2, linea: "11:59 p. m." },
            "Tomate": { recibido: "Seg√∫n empaque", preparado: 2, linea: "11:59 p. m." },
            "Jalape√±os": { recibido: "Seg√∫n empaque", preparado: 60, linea: "11:59 p. m." },
            "Aceituna negra": { recibido: "Seg√∫n empaque", preparado: 7, linea: 2 },
            "Aceituna verde": { recibido: "Seg√∫n empaque", preparado: 7, linea: 2 },
            "Pi√±a - lata": { recibido: "Seg√∫n empaque", preparado: 15, linea: 2 },
            "Pepperoncini": { recibido: "Seg√∫n empaque", preparado: 15, linea: "11:59 p. m." },
            "Salsa pizza - lata": { recibido: "Seg√∫n empaque", preparado: "10 horas", linea: "10 horas" },
            "Salsa de mayonesa con aj√≠ limo": { recibido: "Seg√∫n empaque", preparado: 7, linea: "11:59 p. m." },
            "Salsa rosada (1kg)": { recibido: "Seg√∫n empaque", preparado: 7, linea: "11:59 p. m." },
            "Salsa rosada (0.5 kg)": { recibido: "Seg√∫n empaque", preparado: 7, linea: "11:59 p. m." },
            "Salsa Parrillera": { recibido: "Seg√∫n empaque", preparado: 3, linea: "11:59 p. m." },
            "Salsa de ajo (botella - granel)": { recibido: "Seg√∫n empaque", preparado: 21, linea: "11:59 p. m." },
            "Salsa de mango habanero (bolsa)": { recibido: "Seg√∫n empaque", preparado: 7, linea: "11:59 p. m." },
            "Salsa Ranch": { recibido: "Seg√∫n empaque", preparado: 7, linea: "11:59 p. m." },
            "Salsa Bechamel": { recibido: "Seg√∫n empaque", preparado: 7, linea: "11:59 p. m." },
            "Salsa Chimichurri": { recibido: "Seg√∫n empaque", preparado: 15, linea: 2 },
            "Salsa de ajo (blister - cup)": { recibido: "Seg√∫n empaque", preparado: "Seg√∫n empaque", linea: "11:59 p. m." },
            "Salsa Parmesana (botella - granel)": { recibido: "Seg√∫n empaque", preparado: 21, linea: "11:59 p. m." },
            "Salsa BBQ (blister - cup)": { recibido: "Seg√∫n empaque", preparado: "Seg√∫n empaque", linea: "Seg√∫n empaque" },
            "Salsa BBQ (bolsa)": { recibido: "Seg√∫n empaque", preparado: 4, linea: 2 },
            "Salsa Buffalo (blister - cup)": { recibido: "Seg√∫n empaque", preparado: "Seg√∫n empaque", linea: "Seg√∫n empaque" },
            "Salsa de Miel Picante": { recibido: "Seg√∫n empaque", preparado: 7, linea: "11:59 p. m." },
            "Dustinator": { recibido: "Seg√∫n empaque", preparado: 14, linea: 2 },
            "Masa Croisant": { recibido: 5, preparado: null, linea: "11:59 p. m." },
            "Masa delgada - importada": { recibido: 30, preparado: 3, linea: null },
            "Az√∫car glaseada (Icing) - local": { recibido: "Seg√∫n empaque", preparado: 30, linea: 2 },
            "Cinamon Spreed": { recibido: "Seg√∫n empaque", preparado: 30, linea: 2 },
            "Or√©gano - sachet": { recibido: "Seg√∫n empaque", preparado: "Seg√∫n empaque", linea: "Seg√∫n empaque" },
            "Aji panca - sachet": { recibido: "Seg√∫n empaque", preparado: "Seg√∫n empaque", linea: "Seg√∫n empaque" },
            "Or√©gano - granel": { recibido: "Seg√∫n empaque", preparado: "Seg√∫n empaque", linea: "Seg√∫n empaque" },
            "Aji panca - granel": { recibido: "Seg√∫n empaque", preparado: "Seg√∫n empaque", linea: "Seg√∫n empaque" },
            "Sazonador italiano": { recibido: "Seg√∫n empaque", preparado: 7, linea: 3 },
            "Pasta de lasagna": { recibido: 10, preparado: 8, linea: null },
            "Tortilla": { recibido: "Seg√∫n empaque", preparado: 7, linea: "11:59 p. m." },
            "Manjar Blanco": { recibido: "Seg√∫n empaque", preparado: 15, linea: 5 },
            "Az√∫car Impalpable": { recibido: "Seg√∫n empaque", preparado: 30, linea: 5 },
            "Lasagna (All the meats/The Works/Americana)": { recibido: null, preparado: 4, linea: null },
            "Rollitos de Pepperoni/Jam√≥n": { recibido: null, preparado: "6 horas", linea: "6 horas" },
            "Rollitos de Manjar": { recibido: null, preparado: "6 horas", linea: "6 horas" },
            "Rollitos de Canela": { recibido: null, preparado: "6 horas", linea: "6 horas" }
        };

        const horariosCierre = {
            1: "21:59", 2: "21:59", 3: "21:59",
            4: "22:29", 5: "22:29", 6: "22:29", 0: "22:29"
        };

        // === FUNCIONES DEL FECHADOR ===
        // ... (todo el c√≥digo del fechador se mantiene igual hasta la secci√≥n de INGRESO) ...

        // === FUNCIONES DE INGRESO DE MERCADER√çA ===
        let listaIngreso = [];

        function formatearFecha(fechaStr) {
            if (!fechaStr) return "-";
            const [y, m, d] = fechaStr.split('-');
            return `${d}/${m}/${y}`;
        }

        function sumarDiasISO(fechaISO, dias) {
            const [y, m, d] = fechaISO.split('-').map(Number);
            const fecha = new Date(Date.UTC(y, m - 1, d));
            fecha.setUTCDate(fecha.getUTCDate() + dias);
            return fecha.toISOString().split('T')[0];
        }

        function calcularVencimientoRecibido(producto, fechaRecibido) {
            const info = vidaUtil[producto];
            if (!info || !fechaRecibido) return null;
            if (info.recibido === "Seg√∫n empaque") {
                return "Seg√∫n empaque";
            } else if (typeof info.recibido === 'number') {
                return sumarDiasISO(fechaRecibido, info.recibido);
            } else {
                return "N/A";
            }
        }

        // === NUEVAS FUNCIONES PARA IMPORTAR EXCEL CON VALIDACI√ìN ===

        function normalizar(texto) {
            return texto
                .trim()
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "");
        }

        const productosValidos = Object.keys(vidaUtil);
        const indiceNormalizado = productosValidos.map(p => normalizar(p));

        function encontrarProductoValido(nombreExcel) {
            const normalizado = normalizar(nombreExcel);
            const idx = indiceNormalizado.indexOf(normalizado);
            return idx !== -1 ? productosValidos[idx] : null;
        }

        function importarExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (jsonData.length < 2) {
                        alert("‚ö†Ô∏è El archivo est√° vac√≠o o no tiene datos v√°lidos.");
                        return;
                    }

                    const headers = jsonData[0].map(h => h?.toString().trim().toLowerCase() || "");
                    const productoIndex = headers.findIndex(h => h.includes('producto'));
                    const fechaRecibidoIndex = headers.findIndex(h => 
                        h.includes('fecha recibido') || 
                        h.includes('fecha de recepci') || 
                        h.includes('fecha')
                    );

                    if (productoIndex === -1 || fechaRecibidoIndex === -1) {
                        alert("‚ö†Ô∏è El archivo debe contener columnas 'Producto' y 'Fecha recibido'.");
                        return;
                    }

                    const nuevaLista = [];
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        const productoOriginal = (row[productoIndex] || "").toString().trim();
                        let fechaRecibido = row[fechaRecibidoIndex];

                        if (!productoOriginal) continue;

                        // Normalizar fecha
                        if (typeof fechaRecibido === 'string') {
                            const partes = fechaRecibido.split('/');
                            if (partes.length === 3) {
                                const [d, m, y] = partes.map(Number);
                                const yyyy = y < 100 ? (y > 50 ? 1900 + y : 2000 + y) : y;
                                fechaRecibido = `${yyyy}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                            }
                        } else if (typeof fechaRecibido === 'number') {
                            const date = XLSX.SSF.parse_date_code(fechaRecibido);
                            fechaRecibido = `${date.y}-${String(date.m).padStart(2, '0')}-${String(date.d).padStart(2, '0')}`;
                        }

                        if (!fechaRecibido || !/^\d{4}-\d{2}-\d{2}$/.test(fechaRecibido)) {
                            continue;
                        }

                        const productoValido = encontrarProductoValido(productoOriginal);

                        if (!productoValido) {
                            nuevaLista.push({
                                producto: `‚ö†Ô∏è NO RECONOCIDO: ${productoOriginal}`,
                                fechaRecibido,
                                vidaUtil: "N/A",
                                vencimiento: "N/A",
                                verificado: false
                            });
                        } else {
                            const vencimiento = calcularVencimientoRecibido(productoValido, fechaRecibido);
                            const vidaUtilDias = vidaUtil[productoValido]?.recibido || "N/A";
                            nuevaLista.push({
                                producto: productoValido,
                                fechaRecibido,
                                vidaUtil: vidaUtilDias,
                                vencimiento,
                                verificado: false
                            });
                        }
                    }

                    if (nuevaLista.length === 0) {
                        alert("‚ö†Ô∏è No se encontraron productos v√°lidos en el archivo.");
                        return;
                    }

                    listaIngreso = nuevaLista;
                    renderizarTablaTienda();

                    const noReconocidos = nuevaLista.filter(p => p.producto.startsWith("‚ö†Ô∏è")).length;
                    if (noReconocidos > 0) {
                        alert(`‚úÖ ${nuevaLista.length - noReconocidos} productos importados.\n‚ö†Ô∏è ${noReconocidos} productos no reconocidos. Revise la lista.`);
                    } else {
                        alert(`‚úÖ Todos los productos importados correctamente.`);
                    }
                } catch (error) {
                    console.error(error);
                    alert("‚ùå Error al procesar el archivo Excel. Aseg√∫rese de que el formato es correcto.");
                }
            };
            reader.readAsArrayBuffer(file);
            event.target.value = "";
        }

        // === Resto de funciones de ingreso (sin cambios) ===
        function agregarALista() {
            const producto = document.getElementById('tiendaProducto').value;
            const fechaRecibido = document.getElementById('tiendaFechaRecibido').value;
            if (!producto || !fechaRecibido) {
                alert("‚ö†Ô∏è Seleccione un producto y una fecha de recepci√≥n.");
                return;
            }
            const vencimiento = calcularVencimientoRecibido(producto, fechaRecibido);
            const vidaUtilDias = vidaUtil[producto]?.recibido || "N/A";
            listaIngreso.push({
                producto,
                fechaRecibido,
                vidaUtil: vidaUtilDias,
                vencimiento,
                verificado: false
            });
            renderizarTablaTienda();
        }

        function renderizarTablaTienda(modoVerificacion = false) {
            const thead = document.getElementById('tablaIngresoTiendaHead');
            const tbody = document.getElementById('cuerpoTablaTienda');
            if (modoVerificacion) {
                thead.innerHTML = `
                    <tr>
                        <th>‚úî</th>
                        <th>Producto</th>
                        <th>Fecha recibido</th>
                        <th>Vida √∫til (d√≠as)</th>
                        <th>Fecha vencimiento</th>
                        <th>Acci√≥n</th>
                    </tr>
                `;
            } else {
                thead.innerHTML = `
                    <tr>
                        <th>Producto</th>
                        <th>Fecha recibido</th>
                        <th>Vida √∫til (d√≠as)</th>
                        <th>Fecha vencimiento</th>
                        <th>Acci√≥n</th>
                    </tr>
                `;
            }
            tbody.innerHTML = '';
            listaIngreso.forEach((item, index) => {
                const tr = document.createElement('tr');
                const fechaRecibido = formatearFecha(item.fechaRecibido);
                const fechaVencimiento = item.vencimiento === "Seg√∫n empaque" 
                    ? "Seg√∫n empaque" 
                    : formatearFecha(item.vencimiento);
                if (modoVerificacion) {
                    tr.innerHTML = `
                        <td><input type="checkbox" ${item.verificado ? 'checked' : ''} onchange="toggleVerificado(${index})"></td>
                        <td>${item.producto}</td>
                        <td>${fechaRecibido}</td>
                        <td>${item.vidaUtil}</td>
                        <td>${fechaVencimiento}</td>
                        <td><button class="btn-eliminar" onclick="eliminarProducto(${index})">üóëÔ∏è</button></td>
                    `;
                } else {
                    tr.innerHTML = `
                        <td>${item.producto}</td>
                        <td>${fechaRecibido}</td>
                        <td>${item.vidaUtil}</td>
                        <td>${fechaVencimiento}</td>
                        <td><button class="btn-eliminar" onclick="eliminarProducto(${index})">üóëÔ∏è</button></td>
                    `;
                }
                tbody.appendChild(tr);
            });
        }

        function nuevaLista() {
            if (listaIngreso.length === 0) return;
            if (confirm("¬øDesea empezar una nueva lista? La lista actual se perder√° si no est√° guardada.")) {
                listaIngreso = [];
                renderizarTablaTienda();
            }
        }

        function descargarExcel() {
            if (listaIngreso.length === 0) {
                alert("‚ö†Ô∏è La lista est√° vac√≠a.");
                return;
            }
            const data = listaIngreso.map(item => ({
                Producto: item.producto,
                "Fecha recibido": formatearFecha(item.fechaRecibido),
                "Vida √∫til (d√≠as)": item.vidaUtil,
                "Fecha vencimiento": item.vencimiento === "Seg√∫n empaque" ? "Seg√∫n empaque" : formatearFecha(item.vencimiento)
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Ingreso_Tienda");
            XLSX.writeFile(wb, "Ingreso_Tienda.xlsx");
        }

        function guardarLista() {
            if (listaIngreso.length === 0) {
                alert("‚ö†Ô∏è La lista est√° vac√≠a. No hay nada que guardar.");
                return;
            }
            localStorage.setItem('listaIngresoGuardada', JSON.stringify(listaIngreso));
            alert("‚úÖ Lista guardada exitosamente.");
        }

        function cargarLista() {
            const guardada = localStorage.getItem('listaIngresoGuardada');
            if (!guardada) {
                alert("‚ÑπÔ∏è No hay ninguna lista guardada.");
                return;
            }
            try {
                listaIngreso = JSON.parse(guardada);
                listaIngreso = listaIngreso.map(item => ({
                    ...item,
                    verificado: item.verificado || false
                }));
                renderizarTablaTienda(true);
                alert("‚úÖ Lista cargada. Puede verificar o eliminar productos.");
            } catch (e) {
                alert("‚ùå Error al cargar la lista guardada.");
            }
        }

        function toggleVerificado(index) {
            listaIngreso[index].verificado = !listaIngreso[index].verificado;
            localStorage.setItem('listaIngresoGuardada', JSON.stringify(listaIngreso));
        }

        function eliminarProducto(index) {
            if (confirm("¬øEst√° seguro de que desea eliminar este producto de la lista?")) {
                listaIngreso.splice(index, 1);
                const modoVerificacion = document.querySelector('#tablaIngresoTiendaHead th:first-child').textContent.trim() === '‚úî';
                renderizarTablaTienda(modoVerificacion);
                if (localStorage.getItem('listaIngresoGuardada')) {
                    localStorage.setItem('listaIngresoGuardada', JSON.stringify(listaIngreso));
                }
            }
        }

        // === FUNCIONES DEL FECHADOR (copiadas del original) ===
        function updateShelfLife() {
            const producto = document.getElementById('producto').value;
            const recibidoSection = document.getElementById('recibidoSection');
            const p = document.getElementById('preparadoManualVencInput');
            const l = document.getElementById('lineaManualVencInput');
            if (!producto) {
                recibidoSection.innerHTML = '';
                p.style.display = 'none';
                l.style.display = 'none';
                return;
            }
            const s = vidaUtil[producto];
            if (s.recibido === "Seg√∫n empaque") {
                recibidoSection.innerHTML = `
                    <label>üì¶ RECIBIDO - Fecha de Vencimiento (Seg√∫n empaque):</label>
                    <input type="date" id="recibidoVencFecha" />
                    <p style="color:#7f8c8d; font-size:13px; font-style:italic; margin-top:4px;">* No se requiere fecha de inicio.</p>
                `;
            } else {
                recibidoSection.innerHTML = `
                    <label for="recibidoFecha">üì¶ RECIBIDO - Fecha de Inicio:</label>
                    <input type="date" id="recibidoFecha" />
                `;
            }
            p.style.display = (s.preparado === "Seg√∫n empaque") ? 'block' : 'none';
            l.style.display = (s.linea === "Seg√∫n empaque") ? 'block' : 'none';
        }

        function formatearHora(horaStr) {
            if (!horaStr) return "-";
            const [h, min] = horaStr.split(':');
            let hh = parseInt(h);
            const ampm = hh >= 12 ? 'PM' : 'AM';
            hh = hh % 12 || 12;
            return `${String(hh).padStart(2, '0')}:${min} ${ampm}`;
        }

        function obtenerNombreDia(fechaISO) {
            const diasSemana = ['domingo', 'lunes', 'martes', 'mi√©rcoles', 'jueves', 'viernes', 's√°bado'];
            const fecha = new Date(`${fechaISO}T00:00:00-05:00`);
            return diasSemana[fecha.getDay()];
        }

        function obtenerNombreDiaCompleto(fechaISO, horaStr) {
            if (!fechaISO || !horaStr) return "d√≠a desconocido";
            const [h, min] = horaStr.split(':').map(Number);
            const [y, m, d] = fechaISO.split('-').map(Number);
            const fecha = new Date(Date.UTC(y, m - 1, d, h, min));
            const diasSemana = ['domingo', 'lunes', 'martes', 'mi√©rcoles', 'jueves', 'viernes', 's√°bado'];
            return diasSemana[fecha.getUTCDay()];
        }

        function obtenerHoraCierre(fechaYYYYMMDD) {
            const fecha = new Date(`${fechaYYYYMMDD}T00:00:00-05:00`);
            const diaSemana = fecha.getDay();
            return horariosCierre[diaSemana];
        }

        function obtenerUltimoMinutoDia(fechaISO) {
            const horaCierre = obtenerHoraCierre(fechaISO);
            return {
                fechaISO: fechaISO,
                horaISO: horaCierre,
                fechaMostrar: formatearFecha(fechaISO),
                horaMostrar: formatearHora(horaCierre)
            };
        }

        function montarFilaSticker(etiqueta, fecha, hora, fechaVenc, horaVenc) {
            return `<tr>
                <td class="label">${etiqueta}</td>
                <td>${fecha}</td>
                <td class="time-col"><span>${hora}</span></td>
                <td>${fechaVenc}</td>
                <td class="time-col"><span>${horaVenc}</span></td>
            </tr>`;
        }

        function calcularVencimientos() {
            const producto = document.getElementById('producto').value;
            if (!producto) {
                alert("‚ö†Ô∏è Por favor, seleccione un producto.");
                return;
            }
            const shelfLife = vidaUtil[producto];
            let resumen = [`<strong>${producto}</strong><br><br>`];
            let filas = [];
            let ajustes = [];
            const rF = document.getElementById('recibidoFecha')?.value;
            const pF = document.getElementById('preparadoFecha')?.value;
            const pH = document.getElementById('preparadoHora')?.value;
            const lF = document.getElementById('lineaFecha')?.value;
            const lH = document.getElementById('lineaHora')?.value;

            if (pF && rF) {
                const prepDate = new Date(pF + "T00:00:00-05:00");
                const recibidoDate = new Date(rF + "T00:00:00-05:00");
                if (prepDate < recibidoDate) {
                    alert("‚ö†Ô∏è La fecha de inicio de PREPARADO no puede ser anterior a la de RECIBIDO.");
                    return;
                }
            }
            if (lF && pF) {
                const lineaDate = new Date(lF + "T00:00:00-05:00");
                const prepDate = new Date(pF + "T00:00:00-05:00");
                if (lineaDate < prepDate) {
                    alert("‚ö†Ô∏è La fecha de inicio de L√çNEA no puede ser anterior a la de PREPARADO.");
                    return;
                }
            }

            // --- RECIBIDO ---
            let fechaVencRecibidoISO = null;
            let fechaVencRecibidoMostrar = "-";
            if (shelfLife.recibido === "Seg√∫n empaque") {
                const vF = document.getElementById('recibidoVencFecha')?.value;
                if (vF) {
                    fechaVencRecibidoISO = vF;
                    fechaVencRecibidoMostrar = formatearFecha(vF);
                    resumen.push(`<strong>RECIBIDO:</strong> Seg√∫n empaque ‚Üí ${fechaVencRecibidoMostrar}`);
                } else {
                    resumen.push(`<strong>RECIBIDO:</strong> Seg√∫n empaque ‚Üí No ingresado`);
                    fechaVencRecibidoMostrar = "No ingresado";
                }
                filas.push(montarFilaSticker("RECIB.", "-", "-", fechaVencRecibidoMostrar, "-"));
            } else if (shelfLife.recibido !== null) {
                if (rF) {
                    fechaVencRecibidoISO = sumarDiasISO(rF, shelfLife.recibido);
                    fechaVencRecibidoMostrar = formatearFecha(fechaVencRecibidoISO);
                    resumen.push(`<strong>RECIBIDO:</strong> ${shelfLife.recibido} d√≠a(s) ‚Üí ${fechaVencRecibidoMostrar}`);
                    filas.push(montarFilaSticker("RECIB.", formatearFecha(rF), "-", fechaVencRecibidoMostrar, "-"));
                } else {
                    resumen.push(`<strong>RECIBIDO:</strong> No ingresado`);
                    filas.push(montarFilaSticker("RECIB.", "-", "-", "-", "-"));
                }
            } else {
                resumen.push(`<strong>RECIBIDO:</strong> No aplica`);
                filas.push(montarFilaSticker("RECIB.", "-", "-", "-", "-"));
            }

            // --- PREPARADO ---
            let vencPreparadoOriginal = null;
            let fechaVencPreparadoMostrar = "-", horaVencPreparadoMostrar = "-";
            if (pF && pH) {
                if (shelfLife.preparado === "Seg√∫n empaque") {
                    const vF = document.getElementById('preparadoVencFecha')?.value;
                    const vH = document.getElementById('preparadoVencHora')?.value;
                    if (vF && vH) {
                        vencPreparadoOriginal = { fecha: vF, hora: vH };
                        fechaVencPreparadoMostrar = formatearFecha(vF);
                        horaVencPreparadoMostrar = formatearHora(vH);
                        resumen.push(`<strong>PREPARADO:</strong> Seg√∫n empaque ‚Üí ${fechaVencPreparadoMostrar} ${horaVencPreparadoMostrar}`);
                    } else {
                        fechaVencPreparadoMostrar = horaVencPreparadoMostrar = "No ingresado";
                        resumen.push(`<strong>PREPARADO:</strong> Seg√∫n empaque ‚Üí No ingresado`);
                    }
                } else if (typeof shelfLife.preparado === 'number') {
                    const resultadoNatural = sumarDiasYHorasISO(pF, pH, shelfLife.preparado, 0);
                    if (fechaVencRecibidoISO && resultadoNatural.fechaISO > fechaVencRecibidoISO) {
                        const resultado = obtenerUltimoMinutoDia(fechaVencRecibidoISO);
                        vencPreparadoOriginal = { fecha: resultado.fechaISO, hora: resultado.horaISO };
                        fechaVencPreparadoMostrar = resultado.fechaMostrar;
                        horaVencPreparadoMostrar = resultado.horaMostrar;
                        resumen.push(`<strong>PREPARADO:</strong> Forzado a cierre de RECIBIDO ‚Üí ${resultado.fechaMostrar} ${resultado.horaMostrar}`);
                    } else {
                        vencPreparadoOriginal = { fecha: resultadoNatural.fechaISO, hora: resultadoNatural.horaISO };
                        fechaVencPreparadoMostrar = resultadoNatural.fechaMostrar;
                        horaVencPreparadoMostrar = resultadoNatural.horaMostrar;
                        resumen.push(`<strong>PREPARADO:</strong> ${shelfLife.preparado} d√≠a(s) ‚Üí ${resultadoNatural.fechaMostrar} ${resultadoNatural.horaMostrar}`);
                    }
                } else if (shelfLife.preparado === "11:59 p. m.") {
                    const resultado = obtenerUltimoMinutoDia(pF);
                    vencPreparadoOriginal = { fecha: resultado.fechaISO, hora: resultado.horaISO };
                    fechaVencPreparadoMostrar = resultado.fechaMostrar;
                    horaVencPreparadoMostrar = resultado.horaMostrar;
                    resumen.push(`<strong>PREPARADO:</strong> Hasta cierre ‚Üí ${resultado.fechaMostrar} ${resultado.horaMostrar}`);
                } else if (shelfLife.preparado && shelfLife.preparado.includes("horas")) {
                    const h = parseInt(shelfLife.preparado);
                    const resultado = sumarDiasYHorasISO(pF, pH, 0, h);
                    vencPreparadoOriginal = { fecha: resultado.fechaISO, hora: resultado.horaISO };
                    fechaVencPreparadoMostrar = resultado.fechaMostrar;
                    horaVencPreparadoMostrar = resultado.horaMostrar;
                    resumen.push(`<strong>PREPARADO:</strong> ${h} hora(s) ‚Üí ${resultado.fechaMostrar} ${resultado.horaMostrar}`);
                } else {
                    fechaVencPreparadoMostrar = horaVencPreparadoMostrar = "No aplica";
                    resumen.push(`<strong>PREPARADO:</strong> No aplica`);
                }
                filas.push(montarFilaSticker("PREP", formatearFecha(pF), formatearHora(pH), fechaVencPreparadoMostrar, horaVencPreparadoMostrar));
            } else {
                resumen.push(`<strong>PREPARADO:</strong> No ingresado`);
                filas.push(montarFilaSticker("PREP", "-", "-", "-", "-"));
            }

            // --- L√çNEA ---
            let vencLineaOriginal = null;
            let fechaVencLineaMostrar = "-", horaVencLineaMostrar = "-";
            let vencLineaFinal = null;
            let fechaVencLineaFinalMostrar = "-";
            let horaVencLineaFinalMostrar = "-";
            if (lF && lH) {
                if (shelfLife.linea === "Seg√∫n empaque") {
                    const vF = document.getElementById('lineaVencFecha')?.value;
                    const vH = document.getElementById('lineaVencHora')?.value;
                    if (vF && vH) {
                        vencLineaOriginal = { fecha: vF, hora: vH };
                        fechaVencLineaMostrar = formatearFecha(vF);
                        horaVencLineaMostrar = formatearHora(vH);
                        resumen.push(`<strong>L√çNEA:</strong> Seg√∫n empaque ‚Üí ${fechaVencLineaMostrar} ${horaVencLineaMostrar}`);
                    } else {
                        fechaVencLineaMostrar = horaVencLineaMostrar = "No ingresado";
                        resumen.push(`<strong>L√çNEA:</strong> Seg√∫n empaque ‚Üí No ingresado`);
                    }
                } else if (typeof shelfLife.linea === 'number') {
                    const resultado = sumarDiasYHorasISO(lF, lH, shelfLife.linea, 0);
                    vencLineaOriginal = { fecha: resultado.fechaISO, hora: resultado.horaISO };
                    fechaVencLineaMostrar = resultado.fechaMostrar;
                    horaVencLineaMostrar = resultado.horaMostrar;
                    resumen.push(`<strong>L√çNEA:</strong> ${shelfLife.linea} d√≠a(s) ‚Üí ${resultado.fechaMostrar} ${resultado.horaMostrar}`);
                } else if (shelfLife.linea === "11:59 p. m.") {
                    const resultado = obtenerUltimoMinutoDia(lF);
                    vencLineaOriginal = { fecha: resultado.fechaISO, hora: resultado.horaISO };
                    fechaVencLineaMostrar = resultado.fechaMostrar;
                    horaVencLineaMostrar = resultado.horaMostrar;
                    resumen.push(`<strong>L√çNEA:</strong> Hasta cierre ‚Üí ${resultado.fechaMostrar} ${resultado.horaMostrar}`);
                } else if (shelfLife.linea && shelfLife.linea.includes("horas")) {
                    const h = parseInt(shelfLife.linea);
                    const resultado = sumarDiasYHorasISO(lF, lH, 0, h);
                    vencLineaOriginal = { fecha: resultado.fechaISO, hora: resultado.horaISO };
                    fechaVencLineaMostrar = resultado.fechaMostrar;
                    horaVencLineaMostrar = resultado.horaMostrar;
                    resumen.push(`<strong>L√çNEA:</strong> ${h} hora(s) ‚Üí ${resultado.fechaMostrar} ${resultado.horaMostrar}`);
                } else {
                    fechaVencLineaMostrar = horaVencLineaMostrar = "No aplica";
                    resumen.push(`<strong>L√çNEA:</strong> No aplica`);
                }
                filas.push(montarFilaSticker("LINEA", formatearFecha(lF), formatearHora(lH), fechaVencLineaMostrar, horaVencLineaMostrar));
            } else {
                resumen.push(`<strong>L√çNEA:</strong> No ingresado`);
                filas.push(montarFilaSticker("LINEA", "-", "-", "-", "-"));
            }

            // === AJUSTES AUTOM√ÅTICOS ===
            if (vencPreparadoOriginal && vencLineaOriginal) {
                const prepDateTime = new Date(`${vencPreparadoOriginal.fecha}T${vencPreparadoOriginal.hora}:00-05:00`);
                const lineaDateTime = new Date(`${vencLineaOriginal.fecha}T${vencLineaOriginal.hora}:00-05:00`);
                if (lineaDateTime > prepDateTime) {
                    const nuevaFechaMostrar = formatearFecha(vencPreparadoOriginal.fecha);
                    const nuevaHoraMostrar = formatearHora(vencPreparadoOriginal.hora);
                    vencLineaFinal = { 
                        fecha: vencPreparadoOriginal.fecha, 
                        hora: vencPreparadoOriginal.hora 
                    };
                    fechaVencLineaFinalMostrar = nuevaFechaMostrar;
                    horaVencLineaFinalMostrar = nuevaHoraMostrar;
                    filas[2] = montarFilaSticker("LINEA", formatearFecha(lF), formatearHora(lH), nuevaFechaMostrar, nuevaHoraMostrar);
                    ajustes.push(`L√çNEA ajustado a ${nuevaFechaMostrar} ${nuevaHoraMostrar} (fecha/hora de PREPARADO)`);
                } else {
                    vencLineaFinal = vencLineaOriginal;
                    fechaVencLineaFinalMostrar = fechaVencLineaMostrar;
                    horaVencLineaFinalMostrar = horaVencLineaMostrar;
                }
            } else {
                vencLineaFinal = vencLineaOriginal;
                fechaVencLineaFinalMostrar = fechaVencLineaMostrar;
                horaVencLineaFinalMostrar = horaVencLineaMostrar;
            }

            // Mostrar sticker
            document.getElementById('stickerProducto').textContent = producto;
            document.getElementById('stickerBody').innerHTML = filas.join('');
            const aviso = document.getElementById('ajusteAviso');
            if (ajustes.length > 0) {
                aviso.textContent = "‚ö†Ô∏è Ajustes autom√°ticos aplicados: " + ajustes.join("; ");
                aviso.style.display = 'block';
            } else {
                aviso.style.display = 'none';
            }
            const resumenFechas = document.getElementById('resumenFechas');
            const resumenRecibido = document.getElementById('resumenRecibido');
            const resumenPreparado = document.getElementById('resumenPreparado');
            const resumenLinea = document.getElementById('resumenLinea');
            let recibidoTexto = "-";
            let preparadoTexto = "-";
            let lineaTexto = "-";
            if (fechaVencRecibidoISO) {
                const dia = obtenerNombreDia(fechaVencRecibidoISO);
                const fecha = formatearFecha(fechaVencRecibidoISO);
                recibidoTexto = `${dia} ${fecha}`;
            }
            if (vencPreparadoOriginal) {
                const dia = obtenerNombreDiaCompleto(vencPreparadoOriginal.fecha, vencPreparadoOriginal.hora);
                const fecha = formatearFecha(vencPreparadoOriginal.fecha);
                const hora = formatearHora(vencPreparadoOriginal.hora);
                preparadoTexto = `${dia} ${fecha} a las ${hora}`;
            }
            if (vencLineaFinal) {
                const dia = obtenerNombreDiaCompleto(vencLineaFinal.fecha, vencLineaFinal.hora);
                const fecha = formatearFecha(vencLineaFinal.fecha);
                const hora = formatearHora(vencLineaFinal.hora);
                lineaTexto = `${dia} ${fecha} a las ${hora}`;
            }
            resumenRecibido.textContent = recibidoTexto;
            resumenPreparado.textContent = preparadoTexto;
            resumenLinea.textContent = lineaTexto;
            resumenFechas.style.display = 'block';
            const stickerContainer = document.getElementById('stickerContainer');
            stickerContainer.style.display = 'block';
            stickerContainer.classList.add('fade-in');
            stickerContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function limpiarFormulario() {
            document.getElementById('producto').value = "";
            document.getElementById('recibidoSection').innerHTML = '';
            document.getElementById('preparadoFecha').value = "";
            document.getElementById('preparadoHora').value = "";
            document.getElementById('preparadoVencFecha').value = "";
            document.getElementById('preparadoVencHora').value = "";
            document.getElementById('lineaFecha').value = "";
            document.getElementById('lineaHora').value = "";
            document.getElementById('lineaVencFecha').value = "";
            document.getElementById('lineaVencHora').value = "";
            document.getElementById('stickerContainer').style.display = 'none';
            document.getElementById('resumenFechas').style.display = 'none';
            document.getElementById('ajusteAviso').style.display = 'none';
            document.getElementById('preparadoManualVencInput').style.display = 'none';
            document.getElementById('lineaManualVencInput').style.display = 'none';
            document.getElementById('producto').focus();
        }
    </script>
</body>
</html>
